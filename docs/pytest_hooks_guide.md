# Pytest é’©å­å‡½æ•°ä½¿ç”¨æŒ‡å—

## ä»€ä¹ˆæ˜¯é’©å­å‡½æ•°(Hooks)?

é’©å­å‡½æ•°æ˜¯ pytest åœ¨æµ‹è¯•ç”Ÿå‘½å‘¨æœŸçš„ç‰¹å®šæ—¶åˆ»è‡ªåŠ¨è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºè‡ªå®šä¹‰ pytest çš„è¡Œä¸ºã€‚

## é’©å­å‡½æ•°çš„å®šä¹‰ä½ç½®

é’©å­å‡½æ•°é€šå¸¸åœ¨é¡¹ç›®çš„ **conftest.py** æ–‡ä»¶ä¸­å®šä¹‰ã€‚pytest ä¼šè‡ªåŠ¨å‘ç°å¹¶åŠ è½½è¿™äº›é’©å­ã€‚

## å¸¸ç”¨é’©å­å‡½æ•°è¯¦è§£

### 1. pytest_configure

**è§¦å‘æ—¶æœº**: pytest åˆå§‹åŒ–é…ç½®æ—¶è°ƒç”¨ä¸€æ¬¡

**ç”¨é€”**:
- æ³¨å†Œè‡ªå®šä¹‰æ ‡è®°
- æ·»åŠ å…¨å±€é…ç½®
- åˆå§‹åŒ–æ’ä»¶

**ç¤ºä¾‹**:
```python
def pytest_configure(config):
    """pytesté…ç½®é’©å­"""
    # æ³¨å†Œè‡ªå®šä¹‰æ ‡è®°
    config.addinivalue_line("markers", "smoke: å†’çƒŸæµ‹è¯•")
    config.addinivalue_line("markers", "api: APIæµ‹è¯•")

    # æ‰“å°é…ç½®ä¿¡æ¯
    print("\n" + "="*60)
    print("ğŸš€ Pytest é…ç½®åˆå§‹åŒ–")
    print(f"ğŸ“‚ é¡¹ç›®æ ¹ç›®å½•: {config.rootpath}")
    print("="*60)
```

**å®é™…æ•ˆæœ**:
```
============================================================
ğŸš€ Pytest é…ç½®åˆå§‹åŒ–
ğŸ“‚ é¡¹ç›®æ ¹ç›®å½•: /Users/edy/vs-code/pytest_learn
============================================================
```

---

### 2. pytest_collection_modifyitems

**è§¦å‘æ—¶æœº**: æµ‹è¯•ç”¨ä¾‹æ”¶é›†å®Œæˆåã€æ’åºå‰è°ƒç”¨

**ç”¨é€”**:
- è‡ªåŠ¨æ·»åŠ æ ‡è®°
- åŠ¨æ€ä¿®æ”¹æµ‹è¯•é¡ºåº
- æ ¹æ®æ¡ä»¶è¿‡æ»¤æµ‹è¯•
- ç»Ÿè®¡æµ‹è¯•æ•°é‡

**ç¤ºä¾‹**:
```python
def pytest_collection_modifyitems(config, items):
    """æµ‹è¯•ç”¨ä¾‹æ”¶é›†ä¿®æ”¹é’©å­"""
    # ç»™æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ·»åŠ å¿«é€Ÿ/æ…¢é€Ÿæ ‡è®°
    for item in items:
        if "slow" in item.nodeid.lower():
            item.add_marker(pytest.mark.slow)
        else:
            item.add_marker(pytest.mark.fast)

    # ç»Ÿè®¡æµ‹è¯•æ•°é‡
    print(f"\nğŸ“Š æ”¶é›†åˆ° {len(items)} ä¸ªæµ‹è¯•ç”¨ä¾‹")
```

**å®é™…æ•ˆæœ**:
```
ğŸ“Š æ”¶é›†åˆ° 10 ä¸ªæµ‹è¯•ç”¨ä¾‹
```

---

### 3. pytest_runtest_setup

**è§¦å‘æ—¶æœº**: æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå‰è°ƒç”¨

**ç”¨é€”**:
- æµ‹è¯•å‰çš„æ•°æ®å‡†å¤‡
- æ£€æŸ¥æµ‹è¯•å‰ç½®æ¡ä»¶
- æ‰“å°æµ‹è¯•å¼€å§‹ä¿¡æ¯
- è®°å½•æµ‹è¯•å¼€å§‹æ—¶é—´

**ç¤ºä¾‹**:
```python
def pytest_runtest_setup(item):
    """æµ‹è¯•æ‰§è¡Œå‰é’©å­"""
    # æ‰“å°æµ‹è¯•ç”¨ä¾‹åç§°
    print(f"\nâ–¶ï¸  å¼€å§‹æµ‹è¯•: {item.name}")

    # æ£€æŸ¥æ˜¯å¦åŒ…å«ç‰¹å®šæ ‡è®°
    if item.get_closest_marker("slow"):
        print("  âš ï¸  è¿™æ˜¯ä¸€ä¸ªæ…¢é€Ÿæµ‹è¯•")
```

**å®é™…æ•ˆæœ**:
```
â–¶ï¸  å¼€å§‹æµ‹è¯•: test_hook_demo_1
  ğŸ‰ æµ‹è¯•é€šè¿‡!
```

---

### 4. pytest_runtest_teardown

**è§¦å‘æ—¶æœº**: æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œåè°ƒç”¨ï¼ˆæ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼‰

**ç”¨é€”**:
- æ¸…ç†æµ‹è¯•æ•°æ®
- å…³é—­èµ„æºï¼ˆæ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ç­‰ï¼‰
- æ‰“å°æµ‹è¯•ç»“æŸä¿¡æ¯

**ç¤ºä¾‹**:
```python
def pytest_runtest_teardown(item, nextitem):
    """æµ‹è¯•æ‰§è¡Œåé’©å­"""
    # æ‰“å°æµ‹è¯•å®Œæˆä¿¡æ¯
    print(f"âœ… æµ‹è¯•å®Œæˆ: {item.name}")

    if nextitem:
        print(f"  â­ï¸  ä¸‹ä¸€ä¸ª: {nextitem.name}")
    else:
        print("  ğŸ æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ")
```

**å®é™…æ•ˆæœ**:
```
âœ… æµ‹è¯•å®Œæˆ: test_hook_demo_1
  â­ï¸  ä¸‹ä¸€ä¸ª: test_hook_demo_2
```

---

### 5. pytest_runtest_makereport

**è§¦å‘æ—¶æœº**: æµ‹è¯•ç»“æœç”Ÿæˆæ—¶è°ƒç”¨

**ç”¨é€”**:
- ç”Ÿæˆè‡ªå®šä¹‰æµ‹è¯•æŠ¥å‘Š
- è®°å½•æµ‹è¯•ç»“æœåˆ°æ—¥å¿—
- æ ¹æ®æµ‹è¯•ç»“æœæ‰§è¡Œç‰¹å®šæ“ä½œ
- æ·»åŠ æµ‹è¯•æˆªå›¾ï¼ˆå¤±è´¥æ—¶ï¼‰

**ç¤ºä¾‹**:
```python
def pytest_runtest_makereport(item, call):
    """æµ‹è¯•ç»“æœæŠ¥å‘Šé’©å­"""
    # å½“æµ‹è¯•æ‰§è¡Œå®Œæˆæ—¶ï¼ˆwhen = 'call'ï¼‰
    if call.when == "call":
        # æµ‹è¯•é€šè¿‡æ—¶æ‰“å°ä¿¡æ¯
        if call.excinfo is None:
            print(f"  ğŸ‰ æµ‹è¯•é€šè¿‡!")
        # æµ‹è¯•å¤±è´¥æ—¶æ‰“å°ä¿¡æ¯
        elif call.excinfo.typename not in ("Skipped", "XFailed"):
            print(f"  âŒ æµ‹è¯•å¤±è´¥")
        # æµ‹è¯•è·³è¿‡æ—¶æ‰“å°ä¿¡æ¯
        elif call.excinfo.typename == "Skipped":
            print(f"  â­ï¸  æµ‹è¯•è·³è¿‡")
```

**å®é™…æ•ˆæœ**:
```
â–¶ï¸  å¼€å§‹æµ‹è¯•: test_passing_test
  ğŸ‰ æµ‹è¯•é€šè¿‡!
âœ… æµ‹è¯•å®Œæˆ: test_passing_test

â–¶ï¸  å¼€å§‹æµ‹è¯•: test_failing_test
  âŒ æµ‹è¯•å¤±è´¥
âœ… æµ‹è¯•å®Œæˆ: test_failing_test

â–¶ï¸  å¼€å§‹æµ‹è¯•: test_skipped_test
  â­ï¸  æµ‹è¯•è·³è¿‡
âœ… æµ‹è¯•å®Œæˆ: test_skipped_test
```

---

### 6. pytest_sessionstart

**è§¦å‘æ—¶æœº**: æ•´ä¸ªæµ‹è¯•ä¼šè¯å¼€å§‹æ—¶è°ƒç”¨ä¸€æ¬¡

**ç”¨é€”**:
- åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
- æ‰“å¼€æ•°æ®åº“è¿æ¥
- åˆ›å»ºæµ‹è¯•æ•°æ®ç›®å½•
- è®°å½•ä¼šè¯å¼€å§‹æ—¶é—´

**ç¤ºä¾‹**:
```python
def pytest_sessionstart(session):
    """æµ‹è¯•ä¼šè¯å¼€å§‹é’©å­"""
    print("\n" + "ğŸŒŸ"*30)
    print("ğŸ“‹ æµ‹è¯•ä¼šè¯å¼€å§‹")
    print("ğŸŒŸ"*30)
```

**å®é™…æ•ˆæœ**:
```
ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ
ğŸ“‹ æµ‹è¯•ä¼šè¯å¼€å§‹
ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ
```

---

### 7. pytest_sessionfinish

**è§¦å‘æ—¶æœº**: æ•´ä¸ªæµ‹è¯•ä¼šè¯ç»“æŸæ—¶è°ƒç”¨ä¸€æ¬¡

**ç”¨é€”**:
- æ¸…ç†æµ‹è¯•ç¯å¢ƒ
- å…³é—­æ•°æ®åº“è¿æ¥
- ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
- å‘é€æµ‹è¯•ç»“æœé€šçŸ¥

**ç¤ºä¾‹**:
```python
def pytest_sessionfinish(session, exitstatus):
    """æµ‹è¯•ä¼šè¯ç»“æŸé’©å­"""
    print("\n" + "ğŸŒŸ"*30)
    print("ğŸ“‹ æµ‹è¯•ä¼šè¯ç»“æŸ")
    print(f"ğŸ“Š é€€å‡ºçŠ¶æ€: {exitstatus}")
    print("ğŸŒŸ"*30)
```

**å®é™…æ•ˆæœ**:
```
ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŒğŸŒŸ
ğŸ“‹ æµ‹è¯•ä¼šè¯ç»“æŸ
ğŸ“Š é€€å‡ºçŠ¶æ€: 0
ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŒğŸŒŸ
```

---

## é’©å­å‡½æ•°æ‰§è¡Œé¡ºåº

å®Œæ•´çš„æµ‹è¯•ç”Ÿå‘½å‘¨æœŸé’©å­æ‰§è¡Œé¡ºåºï¼š

```
1. pytest_sessionstart          # ä¼šè¯å¼€å§‹
2. pytest_configure             # é…ç½®åˆå§‹åŒ–
3. pytest_collection_modifyitems # æ”¶é›†å¹¶ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹

å¯¹äºæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š
    4. pytest_runtest_setup      # æµ‹è¯•å¼€å§‹å‰
    5. pytest_runtest_makereport # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š(å¤šä¸ªé˜¶æ®µ)
    6. pytest_runtest_teardown   # æµ‹è¯•å®Œæˆå

7. pytest_sessionfinish         # ä¼šè¯ç»“æŸ
```

---

## å®ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: å¤±è´¥æµ‹è¯•æ—¶è‡ªåŠ¨æˆªå›¾

```python
def pytest_runtest_makereport(item, call):
    """æµ‹è¯•å¤±è´¥æ—¶è‡ªåŠ¨æˆªå›¾"""
    if call.when == "call" and call.excinfo is not None:
        # æµ‹è¯•å¤±è´¥ï¼Œæ‰§è¡Œæˆªå›¾
        if hasattr(item, "obj"):
            screenshot_path = f"screenshots/{item.name}.png"
            # æ‰§è¡Œæˆªå›¾é€»è¾‘
            print(f"  ğŸ“¸ å¤±è´¥æˆªå›¾å·²ä¿å­˜: {screenshot_path}")
```

### ç¤ºä¾‹2: æ ¹æ®ç¯å¢ƒå˜é‡è¿‡æ»¤æµ‹è¯•

```python
def pytest_collection_modifyitems(config, items):
    """æ ¹æ®ç¯å¢ƒå˜é‡è¿‡æ»¤æµ‹è¯•"""
    import os

    # å¦‚æœè®¾ç½®äº† SKIP_SLOW æ ‡å¿—
    if os.getenv("SKIP_SLOW"):
        # ç§»é™¤æ‰€æœ‰æ…¢é€Ÿæµ‹è¯•
        items[:] = [item for item in items
                    if "slow" not in item.nodeid.lower()]
        print(f"\nâš ï¸  å·²è·³è¿‡æ‰€æœ‰æ…¢é€Ÿæµ‹è¯•")
```

### ç¤ºä¾‹3: è®°å½•æµ‹è¯•æ‰§è¡Œæ—¶é—´

```python
def pytest_runtest_setup(item):
    """è®°å½•æµ‹è¯•å¼€å§‹æ—¶é—´"""
    item.start_time = time.time()

def pytest_runtest_teardown(item, nextitem):
    """è®¡ç®—å¹¶æ‰“å°æµ‹è¯•æ‰§è¡Œæ—¶é—´"""
    if hasattr(item, "start_time"):
        elapsed = time.time() - item.start_time
        print(f"  â±ï¸  æ‰§è¡Œæ—¶é—´: {elapsed:.3f}ç§’")
```

---

## è¿è¡Œç¤ºä¾‹

æŸ¥çœ‹é¡¹ç›®ä¸­çš„é’©å­å‡½æ•°ç¤ºä¾‹ï¼š

```bash
# è¿è¡Œæ‰€æœ‰é’©å­ç¤ºä¾‹æµ‹è¯•
pytest tests/test_advanced/test_hooks_examples.py -v -s

# è¿è¡Œç‰¹å®šé’©å­æµ‹è¯•ç±»
pytest tests/test_advanced/test_hooks_examples.py::TestHookBasic -v -s

# æŸ¥çœ‹æ ‡è®°ç›¸å…³çš„é’©å­æ•ˆæœ
pytest tests/test_advanced/test_hooks_examples.py::TestHookMarkers -v -s

# æŸ¥çœ‹å¤±è´¥å’Œè·³è¿‡çš„é’©å­æ•ˆæœ
pytest tests/test_advanced/test_hooks_examples.py::TestHookResults -v -s
```

---

## æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**: é’©å­å‡½æ•°ä¼šåœ¨æ¯ä¸ªæµ‹è¯•æ—¶æ‰§è¡Œï¼Œæ³¨æ„æ€§èƒ½å½±å“
2. **å¼‚å¸¸å¤„ç†**: é’©å­å‡½æ•°ä¸­çš„å¼‚å¸¸ä¼šä¸­æ–­æµ‹è¯•æ‰§è¡Œï¼Œéœ€è¦åšå¥½å¼‚å¸¸å¤„ç†
3. **ä½œç”¨èŒƒå›´**: conftest.py ä¸­çš„é’©å­ä½œç”¨äºå…¶æ‰€åœ¨ç›®å½•åŠå­ç›®å½•
4. **å‚æ•°ä½¿ç”¨**: é’©å­å‡½æ•°çš„å‚æ•°ç”± pytest ä¼ é€’ï¼Œä¸è¦éšæ„ä¿®æ”¹å‚æ•°åˆ—è¡¨

---

## æ€»ç»“

pytest é’©å­å‡½æ•°æä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼Œå¯ä»¥ï¼š
- âœ… è‡ªå®šä¹‰æµ‹è¯•æµç¨‹
- âœ… å¢å¼ºæµ‹è¯•æŠ¥å‘Š
- âœ… å®ç°æµ‹è¯•ç›‘æ§
- âœ… é›†æˆç¬¬ä¸‰æ–¹å·¥å…·

åˆç†ä½¿ç”¨é’©å­å‡½æ•°å¯ä»¥è®©ä½ çš„æµ‹è¯•æ¡†æ¶æ›´åŠ çµæ´»å’Œå¼ºå¤§ï¼
